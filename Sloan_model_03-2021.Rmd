---
title: "The assembly of the rare biosphere based on Sloan's Neutral Model (Shcier 2017)"
author: "Jia Xiu (x.jia@rug.nl)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
html_preview: false
---

refer: https://github.com/seb369/landuse_comm_assembly
Barnett SE, Youngblut ND, Buckley DH. Soil characteristics and land-use drive bacterial community assembly patterns, FEMS Microbiology Ecology, 2020;96(1):fiz194, doi: 10.1093/femsec/fiz194
Burns, A., Stephens, W., Stagaman, K. et al. Contribution of neutral processes to the assembly of gut microbial communities in the zebrafish over host development. ISME J 10, 655-664 (2016) doi:10.1038/ismej.2015.142
https://github.com/seb369/landuse_comm_assembly/blob/master/Neutral_model.md
https://static-content.springer.com/esm/art%3A10.1038%2Fismej.2015.142/MediaObjects/41396_2016_BFismej2015142_MOESM54_ESM.txt


### Initiate libraries
```{r, message=FALSE}
# Clear workspace
rm(list=ls())

# load libraries
library(tidyverse)
# library(tibble)
library(RColorBrewer)
library(minpack.lm)
library(Hmisc)

# plot theme
mytheme <- 
  theme_bw() +
  theme(text = element_text(size=12),
        plot.title = element_text(size=12, face="bold"),
        strip.background = element_blank(),
        strip.text=element_text(color="#666666", face="bold", size = 12),
        legend.box.background = element_rect(),
        legend.box.margin = margin(1, 1, 1, 1),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

# colour used later
my_palette = c(brewer.pal(8, "Pastel1")[c(1:3,6)])

```

## 1. total community
### 1.1 load dataset for analysis
```{r}
cutoff <- 0.1/100
com <- read.csv(paste("feature_table_classified", cutoff, "cutoff.csv", sep="_"),
                    row.names = 1, header = 1)
com <- com[, 1:60]
com <- t(com)
dim(com)
com[1:5, 1:2]
range(rowSums(com))

```

### 1.2 Sloan's neutral model for the total community
```{r}
# Calculate the number of individuals per community (based on rarified OTU table)
range(apply(com, 1, sum))
N <- as.numeric(readline("type the rarefaction depth: "))
warning("Check whether rarefactiondepth (", N, ") is the value your mean (i.e. 31500)?")

# Calculate the average relative abundance of each taxa across communities
p.m <- apply(com, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N
p.df <- data.frame(p) %>% rownames_to_column(var="ASV")
str(p.df)
head(p.df)

# Calculate the occurrence frequency of each taxa
com.bi <- 1*(com>0)
freq <- apply(com.bi, 2, mean)
freq <- freq[freq != 0]
freq.df <- data.frame(freq) %>% rownames_to_column(var="ASV")
str(freq.df)
head(freq.df)

# Combine the average relative abundance and occurrence of each taxa
df <- inner_join(p.df, freq.df, by="ASV") %>% arrange(p)

# Remove rows with any zero (absent in either source pool or local communities). double check!
df <- df %>% filter(freq != 0, p != 0)
str(df)
p <- df$p
freq <- df$freq

#Calculate the limit of detection
d <- 1/N

##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1-p), lower.tail=FALSE), start=list(m=0.1))
m.ci <- confint(m.fit, 'm', level=0.95)
m.sum <- summary(m.fit)
m.coef <- coef(m.fit)

##Calculate goodness-of-fit (R-squared and Root Mean Squared Error)
freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1-p), lower.tail=FALSE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))


# Get table of model fit stats
fitstats <- data.frame(m=m.coef, m.low.ci=m.ci[1], m.up.ci=m.ci[2], 
                       Rsqr=Rsqr, p.value=m.sum$parameters[4], N=N, 
                       Samples=nrow(com), Richness=length(p), 
                       Detect=d)

# Get confidence interval for predictions
freq.pred.ci <- binconf(freq.pred*nrow(com), nrow(com), alpha=0.05, method="wilson", return.df=TRUE)

# Get table of predictions
pred.df <- data.frame(metacomm_RA=p, frequency=freq.pred, 
                      frequency_lowerCI=freq.pred.ci[,2], 
                      frequency_upperCI=freq.pred.ci[,3]) %>%
  unique()

head(pred.df)

# Get table of observed occupancy and abundance
obs.df <- df %>%
  rename(metacomm_RA = p, frequency=freq)


# add classification information (types of rarity or commoness)
# write a table with classifications
ASVs_classified <- com_raw[, 61:ncol(com_raw)] %>% 
  rownames_to_column('ASV') # %>%
# select(ASV, vector_category)
head(ASVs_classified)

obs.df <- left_join(obs.df, ASVs_classified , by = c('ASV')) %>%
  column_to_rownames('ASV')

obs.df$vector_category <- factor(obs.df$vector_category, levels = c("A", "B", "C", "D"), labels = c("Permanently Rare", "Transiently Rare", "Conditionally Rare", "Permanently Common"))

head(obs.df)



(p1 <- ggplot(data=obs.df) +
    geom_point(data=obs.df, aes(x=log10(metacomm_RA), y=frequency, color=vector_category), 
               alpha=.5, size=1) +
    geom_line(data=pred.df, aes(x=log10(metacomm_RA), y=frequency), color="black") + 
    geom_line(data=pred.df, aes(x=log10(metacomm_RA), y=frequency_lowerCI), linetype=2, color="red") + 
    geom_line(data=pred.df, aes(x=log10(metacomm_RA), y=frequency_upperCI), linetype=2, color="red") + 
    geom_text(data=fitstats, aes(label = paste("R^2 == ", round(Rsqr, 3))), 
              x=-5.7, y=0.95, size=4, parse=TRUE) +
    geom_text(data=fitstats, aes(label = paste("italic(m) ==", round(m, 3))), 
              x=-5.7, y=0.85, size=4, parse=TRUE) + 
    labs(x="Log10 abundance in\nmetacommunity", y="Frequency detected", title = "Complete community") +
    scale_colour_manual(values=my_palette) + 
    guides(colour = guide_legend(title="Types of rarity/commoness"))+
    mytheme
)

ggsave(paste("Sloan_neutral_model_com", cutoff, "cutoff.pdf", sep = "_"), p1, width = 17, height = 10, units="cm")

```

## 2. the rare biosphere
### 2.1 load dataset for analysis
```{r}
cutoff <- 0.1/100
rare <- read.csv(paste("truncated_ds_rare_without_dominant", cutoff, "cutoff.csv", sep="_"), row.names = 1, header = 1)
rare <- t(rare)
dim(rare)
rare[1:5, 1:2]
range(rowSums(rare))

```

### 2.2 Sloan's neutral model for the rare biosphere
```{r}
# Calculate the number of individuals per community (based on rarified OTU table)
range(apply(rare, 1, sum))
N <- as.numeric(readline("type the rarefaction depth: "))
warning("Check whether rarefactiondepth (", N, ") is the value your mean (i.e. 31500)?")

# Calculate the average relative abundance of each taxa across communities
p.m <- apply(rare, 2, mean)
p.m <- p.m[p.m != 0]
p <- p.m/N
p.df <- data.frame(p) %>% rownames_to_column(var="ASV")
str(p.df)
head(p.df)

# Calculate the occurrence frequency of each taxa
com.bi <- 1*(rare>0)
freq <- apply(com.bi, 2, mean)
freq <- freq[freq != 0]
freq.df <- data.frame(freq) %>% rownames_to_column(var="ASV")
str(freq.df)
head(freq.df)

# Combine the average relative abundance and occurrence of each taxa
df <- inner_join(p.df, freq.df, by="ASV") %>% arrange(p)

# Remove rows with any zero (absent in either source pool or local communities). double check!
df <- df %>% filter(freq != 0, p != 0)
str(df)
p <- df$p
freq <- df$freq

#Calculate the limit of detection
d <- 1/N

##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1-p), lower.tail=FALSE), start=list(m=0.1))
m.ci <- confint(m.fit, 'm', level=0.95)
m.sum <- summary(m.fit)
m.coef <- coef(m.fit)

##Calculate goodness-of-fit (R-squared and Root Mean Squared Error)
freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1-p), lower.tail=FALSE)
Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))


# Get table of model fit stats
fitstats <- data.frame(m=m.coef, m.low.ci=m.ci[1], m.up.ci=m.ci[2], 
                       Rsqr=Rsqr, p.value=m.sum$parameters[4], N=N, 
                       Samples=nrow(rare), Richness=length(p), 
                       Detect=d)

# Get confidence interval for predictions
freq.pred.ci <- binconf(freq.pred*nrow(rare), nrow(rare), alpha=0.05, method="wilson", return.df=TRUE)

# Get table of predictions
pred.df <- data.frame(metacomm_RA=p, frequency=freq.pred, 
                      frequency_lowerCI=freq.pred.ci[,2], 
                      frequency_upperCI=freq.pred.ci[,3]) %>%
  unique()

head(pred.df)

# Get table of observed occupancy and abundance
obs.df <- df %>%
  rename(metacomm_RA = p, frequency=freq)

head(obs.df)

ASVs_classified <- com_raw[, 61:ncol(com_raw)] %>% 
  rownames_to_column('ASV') %>%
  select(ASV, vector_category)
head(ASVs_classified)

obs.df <- left_join(obs.df, ASVs_classified , by = c('ASV')) %>%
  column_to_rownames('ASV')

obs.df$vector_category <- factor(obs.df$vector_category, levels = c("A", "B", "C", "D"), labels = c("Permanently Rare", "Transiently Rare", "Conditionally Rare", "Permanently Common"))

(p2 <- ggplot(data=obs.df) +
    geom_point(data=obs.df, aes(x=log10(metacomm_RA), y=frequency, color = vector_category), 
               alpha=.1, size=1) +
    geom_line(data=pred.df, aes(x=log10(metacomm_RA), y=frequency), color="black") + 
    geom_line(data=pred.df, aes(x=log10(metacomm_RA), y=frequency_lowerCI), linetype=2, color="red") + 
    geom_line(data=pred.df, aes(x=log10(metacomm_RA), y=frequency_upperCI), linetype=2, color="red") + 
    geom_text(data=fitstats, aes(label = paste("R^2 == ", round(Rsqr, 3))), 
              x=-5.9, y=0.85, size=4, parse=TRUE) +
    geom_text(data=fitstats, aes(label = paste("italic(m) ==", round(m, 3))), 
              x=-5.9, y=0.75, size=4, parse=TRUE) + 
    labs(x="Log10 abundance in\nmetacommunity", y="Frequency detected", title = "Rare biosphere") +
    scale_colour_manual(values=my_palette) + 
    guides(colour = guide_legend(title="Types of rarity/commoness"))+
    mytheme
)

ggsave(paste("Sloan_neutral_model_rare", cutoff, "cutoff.pdf", sep = "_"), p2, width = 11, height = 10, units="cm")

```


### combine the figures
```{r}
library(ggpubr)
(p <- annotate_figure(ggarrange(p1, p2, labels = c("A", "B"), common.legend = TRUE, legend = "right", ncol = 1, nrow = 2), right = " "))
ggsave(paste("Sloan_neutral_model_all", cutoff, "cutoff.pdf", sep = "_"), p, width = 17, height = 20, units="cm")

```

### Session Info

```{r}
sessionInfo()
```